WITH liq_raw AS (
    SELECT
        DATE_TRUNC('day', l.evt_block_time)                              AS day,
        l.evt_tx_hash,
        l.user,
        CAST(l.debtToCover AS DOUBLE) / POWER(10, t.decimals)           AS debt_amount,
        p.price                                                          AS debt_price
    FROM aave_v3_ethereum.Pool_evt_LiquidationCall l
    LEFT JOIN tokens.erc20 t
        ON t.blockchain = 'ethereum'
        AND t.contract_address = l.debtAsset
    LEFT JOIN prices.day p
        ON p.blockchain = 'ethereum'
        AND p.contract_address = l.debtAsset
        AND p.timestamp = DATE_TRUNC('day', l.evt_block_time)
    WHERE l.evt_block_time >= TIMESTAMP '2024-01-01'
)

SELECT
    day,
    COALESCE(SUM(debt_amount * debt_price), 0)  AS liquidations_usd,
    COUNT(*)                                     AS liquidation_count,
    COUNT(DISTINCT user)                         AS unique_users_liquidated
FROM liq_raw
GROUP BY day
ORDER BY day